<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatly Ultra v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.css" />
  <style>
    :root{--bg:#071018;--card:#0e1b24;--muted:#9fb0c8;--accent1:#8b5cf6;--accent2:#22d3ee}
    body{background:linear-gradient(180deg,var(--bg),#03151a);font-family:Inter,system-ui;margin:0;padding:0;min-height:100vh}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.04)}
    .msg-input{background:#071826;border:1px solid #12262e;padding:12px;border-radius:999px;color:#fff}
    .bubble{padding:10px 14px;border-radius:14px;max-width:80%;display:inline-block}
    .bubble.me{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff}
    .bubble.other{background:#0f2228;color:#d1e8ef}
  </style>
</head>
<body class="text-white">
  <div id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  const e = React.createElement;
  const { useState, useEffect, useRef } = React;

  function App(){
    const [token,setToken] = useState(localStorage.getItem('token')||null);
    const [username,setUsername] = useState(localStorage.getItem('username')||'');
    const [view,setView] = useState(token?'main':'auth');
    const [rooms,setRooms] = useState([]);
    const [currentRoom,setCurrentRoom] = useState(null);
    const [messages,setMessages] = useState([]);
    const [online,setOnline] = useState({});
    const socketRef = useRef(null);

    useEffect(()=>{ if(token){ fetchRooms(); initSocket(); } },[token]);

    async function api(path,method='GET',body=null){
      const headers = {'Content-Type':'application/json'}; if(token) headers['Authorization']='Bearer '+token;
      const res = await fetch('/api'+path, { method, headers, body: body?JSON.stringify(body):null });
      return res.json();
    }

    async function fetchRooms(){ const r = await api('/rooms'); setRooms(r.rooms||[]); }

    function initSocket(){
      if(socketRef.current) return;
      const s = io({ auth: { token } });
      s.on('connect', ()=>{});
      s.on('presence', p => setOnline(p));
      s.on('history', msgs => setMessages(msgs));
      s.on('message', m => setMessages(prev=>[...prev,m]));
      s.on('system', sys => setMessages(prev=>[...prev,{ system:true, text:sys.text, timestamp:sys.timestamp }]));
      socketRef.current = s;
    }

    function login(u,p){ fetch('/api/login',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p }) }).then(r=>r.json()).then(j=>{ if(j.token){ localStorage.setItem('token',j.token); localStorage.setItem('username',u); setToken(j.token); setUsername(u); setView('main'); initSocket(); fetchRooms(); } else alert(j.error||'خطأ'); }); }
    function register(u,p){ fetch('/api/register',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p }) }).then(r=>r.json()).then(j=>{ if(j.token){ localStorage.setItem('token',j.token); localStorage.setItem('username',u); setToken(j.token); setUsername(u); setView('main'); initSocket(); fetchRooms(); } else alert(j.error||'خطأ'); }); }
    function logout(){ localStorage.removeItem('token'); localStorage.removeItem('username'); if(socketRef.current) socketRef.current.disconnect(); socketRef.current=null; setToken(null); setUsername(''); setView('auth'); }

    function openRoom(name){ setCurrentRoom(name); if(socketRef.current) socketRef.current.emit('join',{ room: name }); fetch('/api/messages?room='+encodeURIComponent(name)).then(r=>r.json()).then(j=> setMessages(j.messages||[])); }
    function sendMessage(text){ if(!socketRef.current || !currentRoom) return; socketRef.current.emit('message',{ room: currentRoom, text }); }

    return e('div',{className:'min-h-screen flex flex-col'},
      view==='auth' ? e(Auth,{onLogin:login,onRegister:register}) :
      e('div',{className:'flex-1 flex flex-col md:flex-row gap-4 p-4'},
        e('aside',{className:'md:w-80 w-full flex-shrink-0'},
          e('div',{className:'p-4 rounded-2xl glass'}, 
            e('div',{className:'flex items-center gap-3'},
              e('div',{className:'w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-teal-400 flex items-center justify-center text-xl font-bold'}, username[0]||'G'),
              e('div',null, e('div',{className:'font-semibold'}, username), e('div',{className:'text-sm text-muted'}, 'المدير فقط ينشئ الغرف'))
            ),
            e('div',{className:'mt-4 flex flex-col gap-2'}, rooms.map(r=> e('button',{key:r.name||r, className:'text-left p-3 rounded-xl w-full bg-[#071420] hover:bg-[#0f242a]','onClick':()=>openRoom(r.name||r)}, r.name||r)))
          ),
          e('div',{className:'mt-4 p-4 rounded-2xl glass hidden md:block'},
            e('h4',{className:'text-sm font-semibold mb-2'}, 'المتصلون'),
            e('ul',{className:'space-y-2 h-40 overflow-auto scrollbar'}, Object.keys(online).map(k=> e('li',{key:k,className:'flex items-center gap-3'}, e('img',{src:online[k].avatar||'/uploads/default-avatar.png', style:{width:32,height:32,borderRadius:16}}), e('div',null, e('div',{className:'font-medium'}, k), e('div',{className:'text-xs text-muted'}, new Date(online[k].at).toLocaleTimeString())) )))
          )
        ),
        e('main',{className:'flex-1 flex flex-col'},
          e('div',{className:'p-3 rounded-2xl bg-[#071420] flex items-center justify-between'},
            e('div',null, e('h3',{className:'text-lg font-semibold'}, currentRoom||'اختر غرفة')),
            e('div',null, e('button',{className:'px-3 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white','onClick':()=>{ const n=prompt('اسم الغرفة الجديدة'); if(n){ fetch('/api/admin/create-room',{ method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+localStorage.getItem('token') }, body: JSON.stringify({ name:n }) }).then(()=>fetchRooms()); } }}, 'انشاء غرفة (للمدير)'))
          ),
          e('div',{className:'flex-1 overflow-auto p-4 space-y-3 bg-gradient-to-b from-[#03121a] to-transparent rounded-2xl mt-3 messages'},
            messages.map((m,idx)=> m.system ? e('div',{key:idx,className:'text-sm text-center text-muted'}, m.text) :
              e('div',{key:idx, className: 'max-w-xl ' + (m.from===username ? 'ml-auto text-right':'mr-auto text-left')},
                e('div',{className:'text-xs text-muted'}, (m.from||'') + ' • ' + new Date(m.timestamp).toLocaleTimeString()),
                e('div',{className: 'inline-block p-3 rounded-2xl ' + (m.from===username ? 'bubble me':'bubble other')}, m.content && m.content.type==='image' ? e('img',{src:m.content.dataUrl, style:{maxWidth:240,borderRadius:8}}) : (m.content?m.content.text:m.text))
              )
            )
          ),
          e(ChatComposer,{onSend:sendMessage})
        )
      )
    );
  }

  function Auth({onLogin,onRegister}){
    const [u,setU] = useState(''); const [p,setP]=useState('');
    return e('div',{className:'max-w-3xl mx-auto p-6 flex flex-col md:flex-row gap-6'},
      e('section',{className:'flex-1 glass p-6 rounded-2xl'},
        e('h1',{className:'text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-teal-300'},'Chatly Ultra v2'),
        e('p',{className:'mt-2 text-muted'},'واجهة احترافية، متجاوبة، أداء عالي، ولوحة مدير'),
        e('input',{placeholder:'اسم المستخدم', value:u, onChange: e=>setU(e.target.value), className:'mt-6 p-3 rounded-xl w-full bg-[#071826] border border-[#15232b]'}),
        e('input',{placeholder:'كلمة السر', type:'password', value:p, onChange: e=>setP(e.target.value), className:'mt-3 p-3 rounded-xl w-full bg-[#071826] border border-[#15232b]'}),
        e('div',{className:'mt-4 flex gap-3'},
          e('button',{className:'px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600','onClick':()=>onLogin(u,p)},'دخول'),
          e('button',{className:'px-4 py-2 rounded-xl border border-[#22333b]','onClick':()=>onRegister(u,p)},'تسجيل'),
          e('button',{className:'px-4 py-2 rounded-xl border border-[#22333b]','onClick':()=>{ const name='Guest'+Math.floor(Math.random()*9999); localStorage.setItem('username',name); setTimeout(()=>location.reload(),200); }},'دخول كزائر')
        )
      )
    );
  }

  function ChatComposer({onSend}){
    const [text,setText]=useState('');
    return e('div',{className:'mt-3 chat-input sticky bottom-0 p-3 bg-transparent flex gap-2'},
      e('input',{className:'flex-1 msg-input','placeholder':'اكتب رسالة...','value':text,'onChange':(ev)=>setText(ev.target.value),'onKeyDown':(e)=>{ if(e.key==='Enter' && text.trim()){ onSend(text.trim()); setText(''); } }}),
      e('button',{className:'px-4 py-2 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600','onClick':()=>{ if(text.trim()){ onSend(text.trim()); setText(''); } }}, 'إرسال')
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>
