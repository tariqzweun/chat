
{% extends "base.html" %}
{% block content %}
<div class="grid md:grid-cols-4 gap-4">
  <div class="md:col-span-3">
    <div class="bg-white/10 p-4 rounded mb-4">
      <h3 class="text-xl">غرفة: {{ room.name }}</h3>
      <div id="messages" class="messages mt-3">
        {% for m in messages %}
          <div class="msg"><strong>{{ m.user }}</strong>: {{ m.text }} <span class="text-xs text-white/60">({{ m.ts.strftime('%H:%M') }})</span></div>
        {% endfor %}
      </div>
      <div class="mt-3 flex gap-2">
        <input id="msg_input" class="flex-1 p-2 rounded text-black" placeholder="اكتب رسالة...">
        <button id="send_btn" class="py-2 px-4 bg-gradient-to-r from-sky-400 to-purple-500 rounded">إرسال</button>
      </div>
    </div>
  </div>
  <aside class="p-4 bg-white/6 rounded">
    <h4 class="mb-2">الأعضاء</h4>
    <div id="members_list" class="space-y-2">
      {% for m in members %}
        <div class="p-2 bg-white/10 rounded flex justify-between items-center">
          <div>{{ m.username }} <span class="text-sm text-white/60">({{ m.status }})</span></div>
          <div class="flex gap-2">
            <a href="{{ url_for('private_chat', username=m.username) }}" class="text-sm underline">خاص</a>
            {% if current_user.role in ['admin','moderator'] %}
              <button class="kick_btn text-sm text-red-300" data-target="{{ m.username }}">طرد</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </aside>
</div>
<script>
const socket = io();
const ROOM = "{{ room.slug }}";
socket.emit('join', {room: ROOM});
socket.on('message', data => {
  const box = document.getElementById('messages');
  const el = document.createElement('div'); el.className='msg'; el.innerHTML = '<strong>'+data.user+'</strong>: '+data.text;
  box.appendChild(el); box.scrollTop = box.scrollHeight;
});
socket.on('system_message', data => {
  const box = document.getElementById('messages');
  const el = document.createElement('div'); el.className='sys'; el.textContent = data.msg; box.appendChild(el);
});
socket.on('members_update', data => {
  const list = document.getElementById('members_list'); list.innerHTML='';
  data.members.forEach(m => {
    const div = document.createElement('div'); div.className='p-2 bg-white/10 rounded flex justify-between items-center';
    div.innerHTML = '<div>'+m.username+' <span class="text-sm text-white/60">('+m.status+')</span></div><div class="flex gap-2"><a class="text-sm underline" href="/private/'+m.username+'">خاص</a></div>';
    list.appendChild(div);
  });
});
document.getElementById('send_btn').addEventListener('click', ()=>{
  const t = document.getElementById('msg_input'); if(!t.value) return; socket.emit('message',{room:ROOM,text:t.value}); t.value='';
});
document.addEventListener('click', e => {
  if(e.target.classList.contains('kick_btn')){
    const target = e.target.dataset.target;
    socket.emit('kick',{target:target, room:ROOM});
    alert('تم إرسال طلب الطرد');
  }
});
window.addEventListener('beforeunload', ()=> socket.emit('leave',{room:ROOM}));
</script>
{% endblock %}
