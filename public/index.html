<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatly — Modern</title>
  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small custom theme overrides */
    :root{
      --bg:#071018; --card:#0e1b24; --muted:#9fb0c8; --accent1:#7f5cff; --accent2:#32d6c8;
    }
    body{background:linear-gradient(180deg,var(--bg),#03151a);font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    /* smooth scroll for messages */
    .messages { scroll-behavior:smooth; }
  </style>
</head>
<body class="text-white">
  <div id="root"></div>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Socket.IO client -->
  <script src="/socket.io/socket.io.js"></script>

  <script type="text/javascript">
  const e = React.createElement;
  const { useState, useEffect, useRef } = React;

  function App(){
    const [view, setView] = useState('auth'); // auth | main
    const [token, setToken] = useState(localStorage.getItem('token')||null);
    const [username, setUsername] = useState(localStorage.getItem('username')||'');
    const [rooms, setRooms] = useState([]);
    const [currentRoom, setCurrentRoom] = useState(null);
    const [messages, setMessages] = useState([]);
    const [socket, setSocket] = useState(null);
    const msgRef = useRef(null);

    useEffect(()=>{
      if(token){ setView('main'); fetchRooms(); initSocket(); }
    },[token]);

    async function api(path, method='GET', body=null){
      const headers = { 'Content-Type':'application/json' }; if(token) headers['Authorization']='Bearer '+token;
      const res = await fetch('/api'+path,{ method, headers, body: body?JSON.stringify(body):null });
      return res.json();
    }

    async function fetchRooms(){
      const r = await api('/rooms'); setRooms(r.rooms||[]);
    }

    function initSocket(){
      if(socket) return;
      const s = io({ auth: { token } });
      s.on('connect', ()=>{});
      s.on('history', msgs=> setMessages(msgs));
      s.on('message', m=> setMessages(prev=>[...prev,m]));
      s.on('system', sys=> setMessages(prev=>[...prev, { system:true, text:sys.text, timestamp: sys.timestamp }]));
      setSocket(s);
    }

    function login(u,p){
      fetch('/api/login',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username:u, password:p }) })
        .then(r=>r.json()).then(j=>{
          if(j.token){ localStorage.setItem('token', j.token); localStorage.setItem('username', u); setToken(j.token); setUsername(u); setView('main'); initSocket(); fetchRooms(); }
          else alert(j.error||'خطأ تسجيل');
        });
    }

    function register(u,p){
      fetch('/api/register',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ username:u, password:p }) })
        .then(r=>r.json()).then(j=>{
          if(j.token){ localStorage.setItem('token', j.token); localStorage.setItem('username', u); setToken(j.token); setUsername(u); setView('main'); initSocket(); fetchRooms(); }
          else alert(j.error||'خطأ تسجيل');
        });
    }

    function logout(){ localStorage.removeItem('token'); localStorage.removeItem('username'); setToken(null); setUsername(''); setView('auth'); if(socket) socket.disconnect(); setSocket(null); }

    function openRoom(name){
      setCurrentRoom(name);
      if(socket) socket.emit('join',{ room: name });
      // fetch messages via API fallback
      fetch('/api/messages?room='+encodeURIComponent(name)).then(r=>r.json()).then(j=> setMessages(j.messages||[]));
      // show chat panel scroll to bottom later
    }

    function sendMessage(text){
      if(!socket || !currentRoom) return;
      socket.emit('message',{ room: currentRoom, type:'text', text });
    }

    return e('div',{className:'min-h-screen flex flex-col'},
      view==='auth' ? e(AuthPanel,{onLogin:login,onRegister:register,onGuest:(name)=>{ localStorage.setItem('username',name); setUsername(name); setView('main'); initSocket(); fetchRooms(); }}) :
      e(MainPanel,{ username, rooms, onOpen:openRoom, onLogout:logout, currentRoom, messages, onSend:sendMessage })
    );
  }

  function AuthPanel({onLogin,onRegister,onGuest}){
    const [u,setU] = useState(''); const [p,setP] = useState('');
    return e('div',{className:'max-w-3xl mx-auto p-6 flex flex-col md:flex-row gap-6'},
      e('section',{className:'flex-1 card bg-gradient-to-b from-[#071218] to-[#071a21] p-6 rounded-2xl'},
        e('h1',{className:'text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-teal-300'},'Chatly'),
        e('p',{className:'mt-2 text-muted'},'دردشة عصرية متجاوبة للعمل على الهاتف والكمبيوتر'),
        e('input',{placeholder:'اسم المستخدم', value:u, onChange: e=>setU(e.target.value), className:'mt-6 p-3 rounded-xl w-full bg-[#071826] border border-[#15232b]'}),
        e('input',{placeholder:'كلمة السر', type:'password', value:p, onChange: e=>setP(e.target.value), className:'mt-3 p-3 rounded-xl w-full bg-[#071826] border border-[#15232b]'}),
        e('div',{className:'mt-4 flex gap-3'},
          e('button',{className:'px-4 py-2 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600','onClick':()=>onLogin(u,p)},'دخول'),
          e('button',{className:'px-4 py-2 rounded-xl border border-[#22333b]','onClick':()=>onRegister(u,p)},'تسجيل'),
          e('button',{className:'px-4 py-2 rounded-xl border border-[#22333b]','onClick':()=>onGuest('Guest'+Math.floor(Math.random()*9000))},'دخول كزائر')
        )
      ),
      e('section',{className:'flex-1 hidden md:block'},
        e('div',{className:'p-6 rounded-2xl'}, e('h2',{className:'text-xl font-semibold text-muted'},'مميزات'), e('ul',{className:'mt-4 space-y-2 text-muted'}, e('li',null,'واجهات داكنة عصرية'), e('li',null,'دردشة فقاعة'), e('li',null,'لوحة مدير للتحكم بالغرف')))
      )
    );
  }

  function MainPanel({username,rooms,onOpen,onLogout,currentRoom,messages,onSend}){
    const [text,setText] = useState('');
    const msgRef = useRef(null);
    useEffect(()=>{ if(msgRef.current) msgRef.current.scrollTop = msgRef.current.scrollHeight; },[messages]);
    return e('div',{className:'flex-1 flex flex-col md:flex-row gap-4 p-4'},
      // sidebar
      e('aside',{className:'w-full md:w-80 flex-shrink-0'},
        e('div',{className:'p-4 rounded-2xl bg-[#0b1720] sticky top-4'},
          e('div',{className:'flex items-center gap-3'},
            e('div',{className:'w-12 h-12 rounded-full bg-gradient-to-r from-purple-500 to-teal-400 flex items-center justify-center text-xl font-bold'}, username[0]||'G'),
            e('div',null, e('div',{className:'font-semibold'}, username), e('div',{className:'text-sm text-muted'}, 'XP: 1000 • Lv: 1'))
          ),
          e('div',{className:'mt-4 flex flex-col gap-2'},
            rooms.map(r=> e('button',{key:r,className:'text-left p-3 rounded-xl w-full bg-[#071420] hover:bg-[#0f242a]','onClick':()=>onOpen(r)}, r))
          ),
          e('div',{className:'mt-4 flex justify-between'}, e('button',{className:'px-3 py-2 rounded-lg bg-[#2d2f36]','onClick':onLogout},'خروج'), e('div',{className:'text-sm text-muted'}, 'المدير فقط ينشئ الغرف'))
        )
      ),
      // main chat area
      e('main',{className:'flex-1 flex flex-col'},
        e('div',{className:'p-3 rounded-2xl bg-[#071420] flex items-center justify-between'},
          e('div',null, e('h3',{className:'text-lg font-semibold'}, currentRoom||'اختر غرفة')),
          e('div',{className:'text-sm text-muted'}, currentRoom ? 'متصل':'غير متصل')
        ),
        e('div',{ref:msgRef,className:'messages flex-1 overflow-auto p-4 space-y-3 bg-gradient-to-b from-[#03121a] to-transparent rounded-2xl mt-3'},
          messages.map((m,idx)=> m.system ? e('div',{key:idx,className:'text-sm text-center text-muted'}, m.text) :
            e('div',{key:idx,className: 'max-w-xl ' + (m.from===username ? 'ml-auto text-right':'mr-auto text-left')},
              e('div',{className:'text-xs text-muted'}, (m.from||'') + ' • ' + new Date(m.timestamp).toLocaleTimeString()),
              e('div',{className: 'inline-block p-3 rounded-2xl ' + (m.from===username ? 'bg-gradient-to-r from-purple-600 to-indigo-600 text-white' : 'bg-[#0f2228] text-muted')}, m.content && m.content.type==='image' ? e('img',{src:m.content.dataUrl, style:{maxWidth:240,borderRadius:8}}) : m.content?.text)
            )
          )
        ),
        e('div',{className:'mt-3 chat-input sticky bottom-0 p-3 bg-transparent flex gap-2'},
          e('input',{className:'flex-1 p-3 rounded-full bg-[#071826] border border-[#15232b]','placeholder':'اكتب رسالة...','value':text,'onChange':(ev)=>setText(ev.target.value)}),
          e('button',{className:'px-4 py-2 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600','onClick':()=>{ if(text.trim()){ onSend(text.trim()); setText(''); } }}, 'إرسال')
        )
      )
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(e(App));
  </script>
</body>
</html>
